<%# coding: utf-8 %>
<%= bx_title %>

<%= bx_tabs params[:tab] %>

<div class="bx-category-box">
  <%= bx_category_title("bx.label.category.information") %>
  <dl class="bx-informations">
    <dt><%= l("bx.label.category.name") %> :</dt>
    <dd><%= @category.name %></dd>
    <dt><%= l("bx.label.category.description") %> :</dt>
    <dd><%= hbr(@category.description) %></dd>
  </dl>
</div>

<div class="bx-category-box">
  <%= bx_category_title("bx.label.branch.list") %>
<% if @category.branches.empty? %>
  <p class="nodata"><%= l(:label_no_data) %></p>
<% else %>
  <table class="list">
    <thead>
      <tr>
        <th><%= l("bx.label.branch.code") %></th>
        <th><%= l("bx.label.branch.name") %></th>
        <th></th>
      </tr>
    </thead>
    <tbody>
  <% @category.branches.each do |branch| %>
      <tr>
        <td><%= branch.code %></td>
        <td><%= branch.name %></td>
        <td>
          <div class="contextual">
    <% if User.current.allowed_to?(:bx_manage_resources, @project) %>
          <%= link_to l(:button_edit), edit_project_bx_branch_path(@project, branch), :class => 'icon icon-edit', :accesskey => accesskey(:edit) %>
          <%= delete_link project_bx_branch_path(@project, branch) %>
    <% end %>
          </div>
        </td>
      </tr>
  <% end %>
    </tbody>
  </table>
<% end %>
<% if User.current.allowed_to?(:bx_manage_resources, @project) %>
  <p><%= link_to l("bx.label.branch.new"), new_project_bx_category_branch_path(@project, @category), :class => 'icon icon-add' %></p>
<% end %>
</div>

<div class="bx-category-box">
  <%= bx_category_title("bx.label.history.list") %>
<% if @category.histories.empty? %>
  <p class="nodata"><%= l(:label_no_data) %></p>
<% else %>
  <% @category.histories.each do |history| %>
  <div class="bx-history">
    <dl class="bx-informations">
      <dt><%= l("bx.label.history.changed_by") %> :</dt>
      <dd><%= link_to_user(history.changed_user) %></dd>
      <dt><%= l("bx.label.history.changed_at") %> :</dt>
      <dd><%= format_time(history.changed_at) %></dd>
      <dt><%= l("bx.label.history.operation") %> :</dt>
      <dd><%= l("bx.text.history_operations.#{history.operation}", :key => history.key) %></dd>
    <% if history.operation_type != "delete" %>
      <dt><%= l("bx.label.history.details") %> :</dt>
      <dd>
        <ul>
      <% history.details.each do |detail| %>
          <li><%= bx_history_details_note(history, detail) %></li>
      <% end %>
        </ul>
      </dd>
    <% end %>
    <% if history.issues.present? %>
      <dt><%= l("bx.label.relational_issues") %> :</dt>
      <dd>
        <ul>
      <% history.issues.each do |issue| %>
          <li><%= link_to_issue(issue) %></li>
      <% end %>
        </ul>
      </dd>
    <% end %>
    </dl>
  </div>
  <% if @category.histories.last != history %>
  <hr/>
  <% end %>
  <% end %>
  </table>
<% end %>
</div>
